# ⚙️ 汇编代码生成器 详细说明

---

## 📋 1. 概述

`AssemblyGenerator` 类负责将三地址码（TAC）指令列表转换为简化的、类8086汇编代码。  
它目标是为每条TAC指令生成对应汇编指令，管理变量内存分配（栈帧偏移），并处理控制流（跳转和标签）。

---

## 🧩 2. 核心组件与数据结构

| 组件                   | 说明                                                                                     |
|------------------------|------------------------------------------------------------------------------------------|
| 📄 `assemblyCode`       | 存储生成的汇编代码行，按顺序排列                                                         |
| 📦 `variableOffsets`    | 变量名 → 栈帧基址指针 (`BP`) 偏移量映射，例如 `"myVar" -> -2`                            |
| 📉 `currentOffset`      | 当前可用栈帧偏移，变量按2字节递减分配（`-2, -4, -6...`）                                 |
| 🔍 `tempVarComparisonOrigin` | 临时变量（比较操作结果）对应的原始比较符号（`<=`, `>`, `==`等）                             |
| 🔧 正则表达式模式        | 用于匹配和解析不同类型的 TAC 指令字符串                                                   |

---

## 🛠️ 3. 主要方法与逻辑

### 3.1 构造函数 `AssemblyGenerator()`

- 初始化所有数据结构，`currentOffset = -2`

### 3.2 `getVarAssemblyPlace(String varOrTempOrLiteral)`

- 返回变量在汇编中的内存地址形式，如 `WORD PTR [BP-2]`
- 数字字面量直接返回
- 临时变量 `_tX` 假设值在 `AX` 寄存器中，返回 `"AX"`

### 3.3 `loadOperandToRegister(String operand, String register)`

- 将操作数加载到指定寄存器：
  - 数字直接 `MOV reg, value`
  - 变量从内存 `MOV reg, [BP+offset]`
  - 临时变量假设在 `AX`，如目标不是 `AX`，则 `MOV reg, AX`

### 3.4 `generate(List<String> tacInstructions)`

> **核心方法，执行 TAC 到汇编转换**

1. **初始化和清理数据结构**  
2. **程序头部**: `.MODEL SMALL`, `.STACK 100H` 等伪指令  
3. **数据段定义 (.DATA)**  
   - 预扫描所有字符串字面量，定义唯一标签  
   - 定义换行符 `newline_char` 和数字缓冲区 `num_buffer`  
4. **代码段与主过程 (.CODE, MAIN PROC)**  
   - 初始化段寄存器与栈帧  
5. **遍历 TAC 指令逐条翻译**  
   - **声明变量 (`DECLARE varName`)**: 分配栈空间，更新偏移  
   - **二元运算 (`dest = op1 symbol op2`)**: 加载操作数，生成算术或比较指令  
   - **简单赋值 (`dest = source`)**  
   - **条件跳转 (`IF_FALSE condVar GOTO label`)**: 根据原始比较操作生成反条件跳转  
   - **无条件跳转 (`GOTO label`)**  
   - **标签定义 (`label:`)**  
   - **打印数字 (`PRINT var`)**: 调用 `PRINT_NUM` 子过程  
   - **打印字符串 (`PRINT_STR "string"`)**: 使用 DOS 中断打印  
   - **打印换行 (`PRINT_NEWLINE`)**  
   - **返回 (`RETURN value`)**: 设置返回码，调用退出中断  
   - **未匹配指令注释**  
6. **程序尾部**  
   - 栈帧清理和过程结束  
   - 添加打印数字与换行子过程  
   - `END MAIN`

### 3.5 `addPrintNumProcedure()`

- 定义打印 AX 中16位整数的子过程  
- 保存寄存器，处理正负数，数字转字符串，调用 DOS 中断打印

### 3.6 `addPrintNewlineProcedure()`

- 定义打印换行符的子过程  
- 使用 DOS 中断打印 `newline_char`

---

## ⚠️ 4. 关键假设与简化

- 变量和数字皆为16位 (`WORD`)
- 运算结果存放在 `AX`
- 比较结果不直接存储数值，而是通过标志寄存器
- 临时变量 `_tX` 直接假设在 `AX`
- 只支持单过程，未实现复杂函数调用和栈管理
- 输出依赖 DOS 中断 (`INT 21H`)

---

## 🌟 总结

此生成器为三地址码提供了一个基础、可执行的汇编代码表示，适用于 DOS 环境下的 TASM/MASM 编译和运行。

---

## 🖼️ 流程示意图（简化版）

```plaintext
+------------------+
| TAC 指令列表输入 |
+--------+---------+
         |
         v
+------------------+
| 预扫描字符串字面量|
+--------+---------+
         |
         v
+--------------------------+
| 逐条匹配 TAC 指令类型     |
| -> 变量声明              |
| -> 赋值运算              |
| -> 控制流跳转            |
| -> 打印                  |
| -> 返回                  |
+--------+-----------------+
         |
         v
+--------------------------+
| 生成对应汇编代码行       |
| 维护变量偏移和寄存器使用 |
+--------+-----------------+
         |
         v
+--------------------------+
| 添加打印数字/换行子过程  |
+--------+-----------------+
         |
         v
+--------------------------+
| 返回完整汇编代码列表     |
+--------------------------+
````

